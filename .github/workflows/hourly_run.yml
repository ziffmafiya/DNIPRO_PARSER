name: ðŸ”„ Hourly Dnipro Parser

on:
  schedule:
    # Ð—Ð°Ð¿ÑƒÑÐº ÐºÐ°Ð¶Ð´Ñ‹Ðµ 30 Ð¼Ð¸Ð½ÑƒÑ‚ (Ð²Ð¼ÐµÑÑ‚Ð¾ 5)
    - cron: '*/30 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-run:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repository code
        uses: actions/checkout@v4
        with:
          # Ð’Ð°Ð¶Ð½Ð¾ Ð´Ð»Ñ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾Ð³Ð¾ Ð¿ÑƒÑˆÐ° Ð¾Ð±Ñ€Ð°Ñ‚Ð½Ð¾
          fetch-depth: 0 

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: ðŸŽ­ Install Playwright Browsers
        run: playwright install chromium --with-deps

      - name: ðŸ“ Create necessary directories
        run: |
          mkdir -p output/images
          mkdir -p logs
          echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð°Ð¿Ð¾Ðº Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾"

      - name: ðŸ”§ Setup environment
        run: |
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env Ñ„Ð°Ð¹Ð» Ñ ÑÐµÐºÑ€ÐµÑ‚Ð°Ð¼Ð¸ GitHub
          echo "BOT_TOKEN=${{ secrets.BOT_TOKEN }}" > .env
          echo "ADMIN_CHAT_ID=${{ secrets.ADMIN_CHAT_ID }}" >> .env
          echo "GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}" >> .env
          echo "âœ… Environment Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½"

      - name: ðŸš€ Run parser script (Ð½Ð¾Ð²Ð°Ñ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð°)
        run: python -m src.main --parse
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          ADMIN_CHAT_ID: ${{ secrets.ADMIN_CHAT_ID }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ” Debug - List Files (Ð½Ð¾Ð²Ð°Ñ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð°)
        run: |
          echo "ðŸ“‹ Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ ÐºÐ¾Ñ€Ð½Ñ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ:"
          ls -la
          echo ""
          echo "ðŸ“ Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ Ð¿Ð°Ð¿ÐºÐ¸ output (Ð½Ð¾Ð²Ð°Ñ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð°):"
          ls -la output/ || echo "âŒ ÐŸÐ°Ð¿ÐºÐ° output Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°!"
          echo ""
          echo "ðŸ–¼ï¸ Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ Ð¿Ð°Ð¿ÐºÐ¸ output/images:"
          ls -la output/images/ || echo "âŒ ÐŸÐ°Ð¿ÐºÐ° output/images Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°!"
          echo ""
          echo "ðŸ“„ JSON Ñ„Ð°Ð¹Ð»Ñ‹ Ð² output:"
          ls -la output/*.json || echo "âŒ JSON Ñ„Ð°Ð¹Ð»Ñ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹!"
          echo ""
          echo "ðŸ“ Ð›Ð¾Ð³Ð¸:"
          ls -la logs/ || echo "âŒ ÐŸÐ°Ð¿ÐºÐ° logs Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°!"

      - name: ðŸ“Š Show generation statistics
        run: |
          echo "ðŸ“Š Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸:"
          if [ -d "output/images" ]; then
            echo "ðŸ–¼ï¸ ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹: $(find output/images -name "*.png" | wc -l)"
            echo "ðŸ“ Ð Ð°Ð·Ð¼ÐµÑ€ Ð¿Ð°Ð¿ÐºÐ¸ images: $(du -sh output/images 2>/dev/null || echo '0')"
          fi
          if [ -d "output" ]; then
            echo "ðŸ“„ JSON Ñ„Ð°Ð¹Ð»Ñ‹: $(find output -name "*.json" | wc -l)"
          fi
          if [ -d "logs" ]; then
            echo "ðŸ“ Ð›Ð¾Ð³ Ñ„Ð°Ð¹Ð»Ñ‹: $(find logs -name "*.log" | wc -l)"
          fi

      - name: ðŸ’¾ Commit and Push changes (Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾ Ð´Ð»Ñ Ð½Ð¾Ð²Ð¾Ð¹ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹)
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹ Ð¸Ð· Ð½Ð¾Ð²Ð¾Ð¹ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹
          git add output/*.json || echo "â„¹ï¸ ÐÐµÑ‚ JSON Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð´Ð»Ñ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ñ"
          git add output/images/*.png || echo "â„¹ï¸ ÐÐµÑ‚ PNG Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð´Ð»Ñ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ñ"
          git add logs/*.log || echo "â„¹ï¸ ÐÐµÑ‚ Ð»Ð¾Ð³ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð´Ð»Ñ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ñ"
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð¿ÐµÑ€ÐµÐ´ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¾Ð¼
          echo "ðŸ“‹ Git ÑÑ‚Ð°Ñ‚ÑƒÑ:"
          git status
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐµÑÑ‚ÑŒ Ð»Ð¸ Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ (Ð½Ðµ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ timestamp)
          if ! git diff --cached --quiet; then
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
            CHANGED_FILES=$(git diff --cached --name-only | wc -l)
            echo "ï¿½ Ð˜Ð·Ð¼ÐµÐµÐ½ÐµÐ½Ð¾ Ñ„Ð°Ð¹Ð»Ð¾Ð²: $CHANGED_FILES"
            
            if [ "$CHANGED_FILES" -gt 0 ]; then
              echo "âœ… ÐÐ°Ð¹Ð´ÐµÐ½Ñ‹ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ, ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚..."
              git commit -m "ðŸ”„ Update charts and data: $(date +'%Y-%m-%d %H:%M UTC') [v2.0 HTML system]"
              git push origin main
              echo "ðŸš€ Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ñ‹!"
            else
              echo "â„¹ï¸ Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð² timestamp, Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚."
            fi
          else
            echo "â„¹ï¸ ÐÐ¸ÐºÐ°ÐºÐ¸Ñ… Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ Ð½Ðµ Ð¾Ð±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ð¾ - Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð½Ðµ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ð»Ð¸ÑÑŒ."
          fi

      - name: ðŸ“ˆ Workflow Summary
        run: |
          echo "## ðŸŽ¯ Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ñ„Ð°Ð¹Ð»Ð¾Ð²:" >> $GITHUB_STEP_SUMMARY
          if [ -d "output/images" ]; then
            echo "- ðŸ–¼ï¸ Ð˜Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹: $(find output/images -name "*.png" | wc -l)" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -d "output" ]; then
            echo "- ðŸ“„ JSON Ñ„Ð°Ð¹Ð»Ð¾Ð²: $(find output -name "*.json" | wc -l)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš¡ Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð°:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ—ï¸ ÐÑ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð°: HTML/CSS Ñ€ÐµÐ½Ð´ÐµÑ€Ð¸Ð½Ð³ (v2.0)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ­ Ð ÐµÐ½Ð´ÐµÑ€ÐµÑ€: Playwright + Chromium" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“ Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð°: ÐÐ¾Ð²Ð°Ñ Ð¾Ñ€Ð³Ð°Ð½Ð¸Ð·Ð¾Ð²Ð°Ð½Ð½Ð°Ñ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð°" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ• Ð’Ñ€ÐµÐ¼Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ:" >> $GITHUB_STEP_SUMMARY
          echo "- â° Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾: $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
