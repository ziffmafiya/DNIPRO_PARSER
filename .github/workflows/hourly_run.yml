name: ðŸ”„ Hourly Dnipro Parser

on:
  schedule:
    # Ð—Ð°Ð¿ÑƒÑÐº ÐºÐ°Ð¶Ð´Ñ‹Ðµ 30 Ð¼Ð¸Ð½ÑƒÑ‚ (Ð²Ð¼ÐµÑÑ‚Ð¾ 5)
    - cron: '*/30 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-run:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repository code
        uses: actions/checkout@v4
        with:
          # Ð’Ð°Ð¶Ð½Ð¾ Ð´Ð»Ñ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾Ð³Ð¾ Ð¿ÑƒÑˆÐ° Ð¾Ð±Ñ€Ð°Ñ‚Ð½Ð¾
          fetch-depth: 0 

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: ðŸŽ­ Install Playwright Browsers
        run: playwright install chromium --with-deps

      - name: ðŸ“ Create necessary directories
        run: |
          mkdir -p output/images
          mkdir -p logs
          echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð°Ð¿Ð¾Ðº Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾"

      - name: ðŸ”§ Setup environment
        run: |
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env Ñ„Ð°Ð¹Ð» Ñ ÑÐµÐºÑ€ÐµÑ‚Ð°Ð¼Ð¸ GitHub
          echo "BOT_TOKEN=${{ secrets.BOT_TOKEN }}" > .env
          echo "ADMIN_CHAT_ID=${{ secrets.ADMIN_CHAT_ID }}" >> .env
          echo "GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}" >> .env
          echo "âœ… Environment Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½"

      - name: ðŸ§¹ Clean old images before generation
        run: |
          echo "ðŸ—‘ï¸ ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹..."
          
          if [ -d "output/images" ]; then
            echo "ðŸ“Š Ð˜Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹ Ð´Ð¾ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¸: $(find output/images -name "*.png" | wc -l)"
            
            # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰ÑƒÑŽ Ð´Ð°Ñ‚Ñƒ Ð² Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ YYYYMMDD
            CURRENT_DATE=$(date +%Y%m%d)
            YESTERDAY=$(date -d "1 day ago" +%Y%m%d)
            DAY_BEFORE_YESTERDAY=$(date -d "2 days ago" +%Y%m%d)
            
            echo "ðŸ“… Ð¢ÐµÐºÑƒÑ‰Ð°Ñ Ð´Ð°Ñ‚Ð°: $CURRENT_DATE"
            echo "ðŸ“… Ð’Ñ‡ÐµÑ€Ð°: $YESTERDAY" 
            echo "ðŸ“… ÐŸÐ¾Ð·Ð°Ð²Ñ‡ÐµÑ€Ð°: $DAY_BEFORE_YESTERDAY"
            
            # Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ ÐÐ• Ñ ÑÐµÐ³Ð¾Ð´Ð½ÑÑˆÐ½ÐµÐ¹, Ð²Ñ‡ÐµÑ€Ð°ÑˆÐ½ÐµÐ¹ Ð¸Ð»Ð¸ Ð¿Ð¾Ð·Ð°Ð²Ñ‡ÐµÑ€Ð°ÑˆÐ½ÐµÐ¹ Ð´Ð°Ñ‚Ð¾Ð¹
            DELETED_COUNT=0
            for file in output/images/*.png; do
              if [ -f "$file" ]; then
                filename=$(basename "$file")
                # Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ð´Ð°Ñ‚Ñƒ Ð¸Ð· Ð¸Ð¼ÐµÐ½Ð¸ Ñ„Ð°Ð¹Ð»Ð° (Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚: gpv-*-YYYYMMDD-HHMMSS.png)
                if [[ $filename =~ -([0-9]{8})- ]]; then
                  file_date="${BASH_REMATCH[1]}"
                  
                  # Ð•ÑÐ»Ð¸ Ð´Ð°Ñ‚Ð° Ñ„Ð°Ð¹Ð»Ð° Ð½Ðµ ÑÐµÐ³Ð¾Ð´Ð½Ñ, Ð½Ðµ Ð²Ñ‡ÐµÑ€Ð° Ð¸ Ð½Ðµ Ð¿Ð¾Ð·Ð°Ð²Ñ‡ÐµÑ€Ð° - ÑƒÐ´Ð°Ð»ÑÐµÐ¼
                  if [[ "$file_date" != "$CURRENT_DATE" && "$file_date" != "$YESTERDAY" && "$file_date" != "$DAY_BEFORE_YESTERDAY" ]]; then
                    echo "ðŸ—‘ï¸ Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ð¾Ðµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ: $filename (Ð´Ð°Ñ‚Ð°: $file_date)"
                    rm "$file"
                    ((DELETED_COUNT++))
                  fi
                fi
              fi
            done
            
            echo "ðŸ“Š Ð˜Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹ Ð¿Ð¾ÑÐ»Ðµ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¸: $(find output/images -name "*.png" | wc -l)"
            echo "ðŸ—‘ï¸ Ð£Ð´Ð°Ð»ÐµÐ½Ð¾ ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹: $DELETED_COUNT"
            echo "âœ… ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°"
          else
            echo "â„¹ï¸ ÐŸÐ°Ð¿ÐºÐ° output/images Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°"
          fi

      - name: ðŸš€ Run parser script (Ð½Ð¾Ð²Ð°Ñ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð°)
        run: python -m src.main --parse
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          ADMIN_CHAT_ID: ${{ secrets.ADMIN_CHAT_ID }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ” Monitor schedule updates
        run: python -m src.main --monitor
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          ADMIN_CHAT_ID: ${{ secrets.ADMIN_CHAT_ID }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ” Debug - List Files (Ð½Ð¾Ð²Ð°Ñ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð°)
        run: |
          echo "ðŸ“‹ Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ ÐºÐ¾Ñ€Ð½Ñ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ:"
          ls -la
          echo ""
          echo "ðŸ“ Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ Ð¿Ð°Ð¿ÐºÐ¸ output (Ð½Ð¾Ð²Ð°Ñ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð°):"
          ls -la output/ || echo "âŒ ÐŸÐ°Ð¿ÐºÐ° output Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°!"
          echo ""
          echo "ðŸ–¼ï¸ Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ Ð¿Ð°Ð¿ÐºÐ¸ output/images:"
          ls -la output/images/ || echo "âŒ ÐŸÐ°Ð¿ÐºÐ° output/images Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°!"
          echo ""
          echo "ðŸ“„ JSON Ñ„Ð°Ð¹Ð»Ñ‹ Ð² output:"
          ls -la output/*.json || echo "âŒ JSON Ñ„Ð°Ð¹Ð»Ñ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹!"
          echo ""
          echo "ðŸ“ Ð›Ð¾Ð³Ð¸:"
          ls -la logs/ || echo "âŒ ÐŸÐ°Ð¿ÐºÐ° logs Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°!"

      - name: ðŸ“Š Show generation statistics
        run: |
          echo "ðŸ“Š Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸:"
          if [ -d "output/images" ]; then
            echo "ðŸ–¼ï¸ ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹: $(find output/images -name "*.png" | wc -l)"
            echo "ðŸ“ Ð Ð°Ð·Ð¼ÐµÑ€ Ð¿Ð°Ð¿ÐºÐ¸ images: $(du -sh output/images 2>/dev/null || echo '0')"
          fi
          if [ -d "output" ]; then
            echo "ðŸ“„ JSON Ñ„Ð°Ð¹Ð»Ñ‹: $(find output -name "*.json" | wc -l)"
          fi
          if [ -d "logs" ]; then
            echo "ðŸ“ Ð›Ð¾Ð³ Ñ„Ð°Ð¹Ð»Ñ‹: $(find logs -name "*.log" | wc -l)"
          fi

      - name: ðŸ’¾ Commit and Push changes (Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾ Ð´Ð»Ñ Ð½Ð¾Ð²Ð¾Ð¹ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹)
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð¸Ð· Ð½Ð¾Ð²Ð¾Ð¹ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹
          git add output/*.json || echo "â„¹ï¸ ÐÐµÑ‚ JSON Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð´Ð»Ñ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ñ"
          git add output/images/*.png || echo "â„¹ï¸ ÐÐµÑ‚ PNG Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð´Ð»Ñ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ñ"
          git add logs/*.log || echo "â„¹ï¸ ÐÐµÑ‚ Ð»Ð¾Ð³ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð´Ð»Ñ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ñ"
          
          # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÑƒÐ´Ð°Ð»ÐµÐ½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ)
          git add -u output/images/ || echo "â„¹ï¸ ÐÐµÑ‚ ÑƒÐ´Ð°Ð»ÐµÐ½Ð½Ñ‹Ñ… Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹"
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð¿ÐµÑ€ÐµÐ´ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¾Ð¼
          echo "ðŸ“‹ Git ÑÑ‚Ð°Ñ‚ÑƒÑ:"
          git status
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐµÑÑ‚ÑŒ Ð»Ð¸ Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ (Ð½Ðµ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ timestamp)
          if ! git diff --cached --quiet; then
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
            CHANGED_FILES=$(git diff --cached --name-only | wc -l)
            ADDED_FILES=$(git diff --cached --name-status | grep -c "^A" || echo "0")
            DELETED_FILES=$(git diff --cached --name-status | grep -c "^D" || echo "0")
            MODIFIED_FILES=$(git diff --cached --name-status | grep -c "^M" || echo "0")
            
            echo "ðŸ“Š Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹:"
            echo "  ðŸ“ Ð’ÑÐµÐ³Ð¾ Ñ„Ð°Ð¹Ð»Ð¾Ð²: $CHANGED_FILES"
            echo "  âž• Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¾: $ADDED_FILES"
            echo "  âž– Ð£Ð´Ð°Ð»ÐµÐ½Ð¾: $DELETED_FILES"
            echo "  ðŸ“ Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¾: $MODIFIED_FILES"
            
            if [ "$CHANGED_FILES" -gt 0 ]; then
              # Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð°
              COMMIT_MSG="ðŸ”„ Update charts and data: $(date +'%Y-%m-%d %H:%M UTC') [v2.0 HTML system]"
              
              if [ "$DELETED_FILES" -gt 0 ]; then
                COMMIT_MSG="$COMMIT_MSG

ðŸ—‘ï¸ Cleaned up $DELETED_FILES old images"
              fi
              
              if [ "$ADDED_FILES" -gt 0 ]; then
                COMMIT_MSG="$COMMIT_MSG
âž• Added $ADDED_FILES new images"
              fi
              
              echo "âœ… Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚ Ñ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸ÐµÐ¼:"
              echo "$COMMIT_MSG"
              
              git commit -m "$COMMIT_MSG"
              git push origin main
              echo "ðŸš€ Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ñ‹!"
            else
              echo "â„¹ï¸ Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð² timestamp, Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚."
            fi
          else
            echo "â„¹ï¸ ÐÐ¸ÐºÐ°ÐºÐ¸Ñ… Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ Ð½Ðµ Ð¾Ð±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ð¾ - Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð½Ðµ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ð»Ð¸ÑÑŒ."
          fi

      - name: ðŸ“ˆ Workflow Summary
        run: |
          echo "## ðŸŽ¯ Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ñ„Ð°Ð¹Ð»Ð¾Ð²:" >> $GITHUB_STEP_SUMMARY
          if [ -d "output/images" ]; then
            echo "- ðŸ–¼ï¸ Ð˜Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹: $(find output/images -name "*.png" | wc -l)" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -d "output" ]; then
            echo "- ðŸ“„ JSON Ñ„Ð°Ð¹Ð»Ð¾Ð²: $(find output -name "*.json" | wc -l)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš¡ Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð°:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ—ï¸ ÐÑ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð°: HTML/CSS Ñ€ÐµÐ½Ð´ÐµÑ€Ð¸Ð½Ð³ (v2.0)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ­ Ð ÐµÐ½Ð´ÐµÑ€ÐµÑ€: Playwright + Chromium" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“ Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð°: ÐÐ¾Ð²Ð°Ñ Ð¾Ñ€Ð³Ð°Ð½Ð¸Ð·Ð¾Ð²Ð°Ð½Ð½Ð°Ñ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð°" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ• Ð’Ñ€ÐµÐ¼Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ:" >> $GITHUB_STEP_SUMMARY
          echo "- â° Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾: $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ§¹ ÐžÑ‡Ð¸ÑÑ‚ÐºÐ°:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ—‘ï¸ ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹ ÑÑ‚Ð°Ñ€ÑˆÐµ 3 Ð´Ð½ÐµÐ¹" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“… Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÑŽÑ‚ÑÑ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ð³Ñ€Ð°Ñ„Ð¸ÐºÐ¸" >> $GITHUB_STEP_SUMMARY