# Повна інструкція: Systemd Service та Timer для автозапуску бота на Debian

## Частина 1: Створення Service

### Крок 1: Створіть service файл
```bash
sudo nano /etc/systemd/system/DNIPRO_PARSER.service
```

### Крок 2: Вставте конфігурацію service

Для постійно працюючого бота:
```ini
[Unit]
Description=DNIPRO_PARSER
After=network.target

[Service]
Type=simple
User=yaroslav
WorkingDirectory=/home/yaroslav/bots/DNIPRO_PARSER
ExecStart=/bin/bash /home/yaroslav/bots/DNIPRO_PARSER/run_main.sh
Restart=always
RestartSec=10
Environment=PYTHONUNBUFFERED=1

[Install]
WantedBy=multi-user.target
```

Для періодичного запуску (з timer):
```ini
[Unit]
Description=DNIPRO_PARSER
After=network.target

[Service]
Type=oneshot
User=yaroslav
WorkingDirectory=/home/yaroslav/bots/DNIPRO_PARSER
ExecStart=/bin/bash /home/yaroslav/bots/DNIPRO_PARSER/run_main.sh
Environment=PYTHONUNBUFFERED=1

[Install]
WantedBy=multi-user.target
```

### Крок 3: Збережіть файл
Натисніть: `Ctrl+O` → `Enter` → `Ctrl+X`

---

## Частина 2: Створення Timer (для періодичного запуску)

### Крок 1: Створіть timer файл
```bash
sudo nano /etc/systemd/system/DNIPRO_PARSER.timer
```

### Крок 2: Вставте конфігурацію timer

**Варіант 1: Запуск кожні 5 хвилин**
```ini
[Unit]
Description=DNIPRO_PARSER Timer
Requires=DNIPRO_PARSER.service

[Timer]
OnBootSec=2min
OnUnitActiveSec=5min
Unit=DNIPRO_PARSER.service

[Install]
WantedBy=timers.target
```

**Варіант 2: Запуск кожну годину**
```ini
[Unit]
Description=DNIPRO_PARSER Timer
Requires=DNIPRO_PARSER.service

[Timer]
OnBootSec=2min
OnUnitActiveSec=1h
Unit=DNIPRO_PARSER.service

[Install]
WantedBy=timers.target
```

**Варіант 3: Запуск щодня о 03:00**
```ini
[Unit]
Description=DNIPRO_PARSER Timer
Requires=DNIPRO_PARSER.service

[Timer]
OnCalendar=daily
OnCalendar=03:00
Unit=DNIPRO_PARSER.service

[Install]
WantedBy=timers.target
```

**Варіант 4: Запуск кожні 15 хвилин**
```ini
[Unit]
Description=DNIPRO_PARSER Timer
Requires=DNIPRO_PARSER.service

[Timer]
OnBootSec=2min
OnUnitActiveSec=15min
Unit=DNIPRO_PARSER.service

[Install]
WantedBy=timers.target
```

### Крок 3: Збережіть файл
Натисніть: `Ctrl+O` → `Enter` → `Ctrl+X`

---

## Частина 3: Активація Service (без timer)

Якщо бот повинен працювати постійно:

```bash
# 1. Перезавантажте systemd
sudo systemctl daemon-reload

# 2. Увімкніть автозапуск
sudo systemctl enable DNIPRO_PARSER.service

# 3. Запустіть service
sudo systemctl start DNIPRO_PARSER.service

# 4. Перевірте статус
sudo systemctl status DNIPRO_PARSER.service
```

---

## Частина 4: Активація Timer (періодичний запуск)

Якщо бот повинен запускатися періодично:

```bash
# 1. Перезавантажте systemd
sudo systemctl daemon-reload

# 2. Увімкніть timer (НЕ service!)
sudo systemctl enable DNIPRO_PARSER.timer

# 3. Запустіть timer
sudo systemctl start DNIPRO_PARSER.timer

# 4. Перевірте статус timer
sudo systemctl status DNIPRO_PARSER.timer

# 5. Подивіться всі таймери
sudo systemctl list-timers --all
```

---

## Частина 5: Управління Service

### Основні команди
```bash
# Запустити
sudo systemctl start DNIPRO_PARSER.service

# Зупинити
sudo systemctl stop DNIPRO_PARSER.service

# Перезапустити
sudo systemctl restart DNIPRO_PARSER.service

# Перевірити статус
sudo systemctl status DNIPRO_PARSER.service

# Увімкнути автозапуск
sudo systemctl enable DNIPRO_PARSER.service

# Вимкнути автозапуск
sudo systemctl disable DNIPRO_PARSER.service
```

### Перегляд логів
```bash
# Логи в реальному часі
sudo journalctl -u DNIPRO_PARSER.service -f

# Останні 100 рядків
sudo journalctl -u DNIPRO_PARSER.service -n 100

# Логи за сьогодні
sudo journalctl -u DNIPRO_PARSER.service --since today

# Логи за останню годину
sudo journalctl -u DNIPRO_PARSER.service --since "1 hour ago"
```

---

## Частина 6: Управління Timer

### Основні команди
```bash
# Запустити timer
sudo systemctl start DNIPRO_PARSER.timer

# Зупинити timer
sudo systemctl stop DNIPRO_PARSER.timer

# Перезапустити timer
sudo systemctl restart DNIPRO_PARSER.timer

# Перевірити статус timer
sudo systemctl status DNIPRO_PARSER.timer

# Увімкнути автозапуск timer
sudo systemctl enable DNIPRO_PARSER.timer

# Вимкнути автозапуск timer
sudo systemctl disable DNIPRO_PARSER.timer

# Подивіться всі активні таймери
sudo systemctl list-timers

# Подивіться всі таймери (включно з неактивними)
sudo systemctl list-timers --all
```

### Перегляд логів timer
```bash
# Логи timer
sudo journalctl -u DNIPRO_PARSER.timer -f

# Логи service (що запускається timer'ом)
sudo journalctl -u DNIPRO_PARSER.service -f

# Обидва логи разом
sudo journalctl -u DNIPRO_PARSER.timer -u DNIPRO_PARSER.service -f
```

---

## Частина 7: Редагування конфігурації

### Якщо потрібно змінити налаштування:

```bash
# 1. Відредагуйте файл
sudo nano /etc/systemd/system/DNIPRO_PARSER.service
# або
sudo nano /etc/systemd/system/DNIPRO_PARSER.timer

# 2. Обов'язково перезавантажте systemd
sudo systemctl daemon-reload

# 3. Перезапустіть service або timer
sudo systemctl restart DNIPRO_PARSER.service
# або
sudo systemctl restart DNIPRO_PARSER.timer
```

---

## Частина 8: Налаштування часу для Timer

### Приклади OnUnitActiveSec (інтервал після завершення):
```ini
OnUnitActiveSec=5min      # Кожні 5 хвилин
OnUnitActiveSec=15min     # Кожні 15 хвилин
OnUnitActiveSec=30min     # Кожні 30 хвилин
OnUnitActiveSec=1h        # Кожну годину
OnUnitActiveSec=2h        # Кожні 2 години
OnUnitActiveSec=6h        # Кожні 6 годин
OnUnitActiveSec=12h       # Кожні 12 годин
OnUnitActiveSec=1d        # Кожного дня
```

### Приклади OnCalendar (конкретний час):
```ini
OnCalendar=hourly              # Кожну годину (о 00 хвилин)
OnCalendar=daily               # Кожного дня о 00:00
OnCalendar=weekly              # Кожного тижня (неділя о 00:00)
OnCalendar=monthly             # Кожного місяця (1-го числа о 00:00)

OnCalendar=03:00               # Щодня о 03:00
OnCalendar=Mon 09:00           # Кожного понеділка о 09:00
OnCalendar=Mon-Fri 08:00       # З понеділка по п'ятницю о 08:00
OnCalendar=*-*-* 12:00:00      # Щодня о 12:00
OnCalendar=*:0/10              # Кожні 10 хвилин (00, 10, 20, 30...)
OnCalendar=Mon,Wed,Fri 18:00   # ПН, СР, ПТ о 18:00
```

### OnBootSec (запуск після завантаження):
```ini
OnBootSec=1min     # Через 1 хвилину після завантаження
OnBootSec=5min     # Через 5 хвилин після завантаження
OnBootSec=10min    # Через 10 хвилин після завантаження
```

---

## Частина 9: Пояснення параметрів Service

### [Unit]
- `Description=` — опис service
- `After=network.target` — запускати після ініціалізації мережі

### [Service]
- `Type=simple` — звичайний процес (для постійно працюючих ботів)
- `Type=oneshot` — одноразове виконання (для періодичних запусків з timer)
- `User=` — під яким користувачем запускати
- `WorkingDirectory=` — робоча директорія
- `ExecStart=` — команда для запуску
- `Restart=always` — завжди перезапускати (при будь-якому завершенні)
- `Restart=on-failure` — перезапускати тільки при помилці
- `RestartSec=10` — пауза перед перезапуском (секунди)
- `Environment=` — змінні оточення

### [Install]
- `WantedBy=multi-user.target` — запускати в багатокористувацькому режимі

---

## Частина 10: Пояснення параметрів Timer

### [Unit]
- `Description=` — опис timer
- `Requires=` — який service потрібен для роботи

### [Timer]
- `OnBootSec=` — через скільки після завантаження системи
- `OnUnitActiveSec=` — інтервал між запусками
- `OnCalendar=` — запуск в конкретний час
- `Unit=` — який service запускати

### [Install]
- `WantedBy=timers.target` — додати до групи таймерів

---

## Частина 11: Тестування

### Перевірка перед запуском:
```bash
# Перевірте, чи існує скрипт
ls -la /home/yaroslav/bots/DNIPRO_PARSER/run_main.sh

# Перевірте права на виконання
chmod +x /home/yaroslav/bots/DNIPRO_PARSER/run_main.sh

# Запустіть скрипт вручну для тесту
bash /home/yaroslav/bots/DNIPRO_PARSER/run_main.sh

# Перевірте синтаксис service файлу
sudo systemd-analyze verify /etc/systemd/system/DNIPRO_PARSER.service

# Перевірте синтаксис timer файлу
sudo systemd-analyze verify /etc/systemd/system/DNIPRO_PARSER.timer
```

---

## Частина 12: Вирішення проблем

### Service не запускається:
```bash
# Подивіться детальні логи помилок
sudo journalctl -xe -u DNIPRO_PARSER.service

# Перевірте статус
sudo systemctl status DNIPRO_PARSER.service

# Запустіть скрипт вручну від імені користувача
su - yaroslav -c "bash /home/yaroslav/bots/DNIPRO_PARSER/run_main.sh"
```

### Timer не спрацьовує:
```bash
# Перевірте, чи timer активний
sudo systemctl is-active DNIPRO_PARSER.timer

# Подивіться, коли буде наступний запуск
sudo systemctl list-timers --all | grep DNIPRO_PARSER

# Запустіть service вручну для тесту
sudo systemctl start DNIPRO_PARSER.service
```

### Загальні проблеми:
```bash
# Перезавантажте systemd після змін
sudo systemctl daemon-reload

# Перевірте, чи немає конфліктуючих процесів
ps aux | grep downloader

# Перевірте права на файли
ls -la /home/yaroslav/bots/DNIPRO_PARSER/
```

---

## Частина 13: Видалення Service та Timer

### Якщо потрібно видалити:
```bash
# 1. Зупиніть і вимкніть timer
sudo systemctl stop DNIPRO_PARSER.timer
sudo systemctl disable DNIPRO_PARSER.timer

# 2. Зупиніть і вимкніть service
sudo systemctl stop DNIPRO_PARSER.service
sudo systemctl disable DNIPRO_PARSER.service

# 3. Видаліть файли
sudo rm /etc/systemd/system/DNIPRO_PARSER.service
sudo rm /etc/systemd/system/DNIPRO_PARSER.timer

# 4. Перезавантажте systemd
sudo systemctl daemon-reload

# 5. Скиньте помилки (якщо є)
sudo systemctl reset-failed
```

---

## Частина 14: Додаткові налаштування

### Обмеження використання ресурсів:
Додайте в секцію [Service]:
```ini
MemoryLimit=512M          # Обмеження пам'яті
CPUQuota=50%              # Обмеження CPU (50%)
TasksMax=100              # Максимум процесів/потоків
```

### Затримка перед запуском:
```ini
ExecStartPre=/bin/sleep 5  # Чекати 5 секунд перед запуском
```

### Логування в окремий файл:
```ini
StandardOutput=append:/var/log/zak_parser.log
StandardError=append:/var/log/zak_parser_error.log
```

### Повідомлення при помилках (email):
Додайте в секцію [Service]:
```ini
OnFailure=status-email@%n.service
```

---

## Швидкий довідник команд

```bash
# SERVICE
sudo systemctl start DNIPRO_PARSER.service      # Запустити
sudo systemctl stop DNIPRO_PARSER.service       # Зупинити
sudo systemctl restart DNIPRO_PARSER.service    # Перезапустити
sudo systemctl status DNIPRO_PARSER.service     # Статус
sudo systemctl enable DNIPRO_PARSER.service     # Автозапуск ON
sudo systemctl disable DNIPRO_PARSER.service    # Автозапуск OFF

# TIMER
sudo systemctl start DNIPRO_PARSER.timer        # Запустити
sudo systemctl stop DNIPRO_PARSER.timer         # Зупинити
sudo systemctl restart DNIPRO_PARSER.timer      # Перезапустити
sudo systemctl status DNIPRO_PARSER.timer       # Статус
sudo systemctl enable DNIPRO_PARSER.timer       # Автозапуск ON
sudo systemctl disable DNIPRO_PARSER.timer      # Автозапуск OFF
sudo systemctl list-timers                      # Список таймерів

# СИСТЕМНІ
sudo systemctl daemon-reload                    # Перезавантажити конфігурацію
sudo journalctl -u DNIPRO_PARSER.service -f    # Логи service
sudo journalctl -u DNIPRO_PARSER.timer -f      # Логи timer
```

---

**Автор:** Інструкція для налаштування systemd service та timer  
**Дата:** 2025
